import React, { useState } from 'react';
import { Button, Input, Card, CardContent } from '@/components/ui';

const redirectUri = 'https://jrakwasi.github.io/akwasi/';
const clientId = '82910fe423f24953a93aa6188fd25c58';
const authEndpoint = 'https://accounts.spotify.com/authorize';
const scopes = ['playlist-modify-public', 'playlist-modify-private'];
const apiUrl = 'https://api.spotify.com/v1';

export default function SpotifyPlaylistCreator() {
  const [songs, setSongs] = useState('');
  const [matchedSongs, setMatchedSongs] = useState([]);
  const [selectedSongs, setSelectedSongs] = useState([]);
  const [token, setToken] = useState(null);

  const authenticate = () => {
    const authUrl = `${authEndpoint}?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scopes.join('%20')}&response_type=token&show_dialog=true`;
    window.location.href = authUrl;
  };

  const searchSongs = async () => {
    if (!token) return alert('Please authenticate first.');
    const songList = songs.split('\n');
    let matched = [];
    
    for (let song of songList) {
      const response = await fetch(`${apiUrl}/search?q=${encodeURIComponent(song)}&type=track`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await response.json();
      if (data.tracks && data.tracks.items.length > 0) {
        matched.push({ input: song, options: data.tracks.items.slice(0, 3) });
      }
    }
    setMatchedSongs(matched);
  };

  const createPlaylist = async () => {
    if (!token || selectedSongs.length === 0) return;
    
    const userResponse = await fetch(`${apiUrl}/me`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    const userData = await userResponse.json();
    
    const playlistResponse = await fetch(`${apiUrl}/users/${userData.id}/playlists`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ name: 'Generated Playlist', public: true }),
    });
    const playlistData = await playlistResponse.json();
    
    await fetch(`${apiUrl}/playlists/${playlistData.id}/tracks`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ uris: selectedSongs }),
    });
    alert('Playlist created successfully!');
  };

  return (
    <div className="p-4 max-w-lg mx-auto">
      <Button onClick={authenticate} className="mb-4">Authenticate with Spotify</Button>
      <Input
        placeholder="Enter songs, one per line"
        value={songs}
        onChange={(e) => setSongs(e.target.value)}
        className="w-full mb-4"
        multiline
      />
      <Button onClick={searchSongs} className="mb-4">Generate Preview</Button>
      <div>
        {matchedSongs.map((match, index) => (
          <Card key={index} className="mb-4">
            <CardContent>
              <p>Input: {match.input}</p>
              {match.options.map((track, i) => (
                <div key={i} className="flex items-center justify-between p-2 border rounded">
                  <p>{track.name} - {track.artists.map(a => a.name).join(', ')}</p>
                  <Button onClick={() => setSelectedSongs([...selectedSongs, track.uri])}>Select</Button>
                </div>
              ))}
            </CardContent>
          </Card>
        ))}
      </div>
      <Button onClick={createPlaylist} className="mt-4">Create Playlist</Button>
    </div>
  );
}
