import React, { useState, useEffect } from "react";
import { Button, Input, Card, CardContent } from "./components/ui"; // Ensure this file exists in the correct directory

const CLIENT_ID = "82910fe423f24953a93aa6188fd25c58";
const REDIRECT_URI = "https://jrakwasi.github.io/akwasi/";
const SCOPES = "playlist-modify-private playlist-modify-public";

export default function SpotifyPlaylistCreator() {
  const [songs, setSongs] = useState("");
  const [token, setToken] = useState(null);
  
  const authenticateSpotify = () => {
    const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
    window.location.href = authUrl;
  };

  useEffect(() => {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const accessToken = params.get("access_token");
    if (accessToken) {
      setToken(accessToken);
      window.history.pushState({}, null, window.location.pathname);
    }
  }, []);

  const createPlaylist = async () => {
    if (!token) return alert("Please authenticate first!");
    const songList = songs.split("\n").map(song => song.trim()).filter(song => song);
    if (songList.length === 0) return alert("No songs provided!");
    
    try {
      const userResponse = await fetch("https://api.spotify.com/v1/me", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const userData = await userResponse.json();
      if (!userData.id) throw new Error("Failed to fetch user ID");
      const userId = userData.id;
      
      const playlistResponse = await fetch(`https://api.spotify.com/v1/users/${userId}/playlists`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ name: "My Generated Playlist", public: false })
      });
      const playlistData = await playlistResponse.json();
      if (!playlistData.id) throw new Error("Failed to create playlist");
      const playlistId = playlistData.id;
      
      const uris = [];
      for (const song of songList) {
        const searchResponse = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(song)}&type=track&limit=1`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const searchData = await searchResponse.json();
        const track = searchData.tracks?.items?.[0];
        if (track) uris.push(track.uri);
      }
      
      if (uris.length === 0) return alert("No valid songs found!");
      
      await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ uris })
      });
      alert("Playlist created successfully!");
    } catch (error) {
      console.error("Error creating playlist:", error);
      alert(`An error occurred: ${error.message}`);
    }
  };
  
  return (
    <Card className="p-4">
      <CardContent>
        <h2 className="text-xl font-bold mb-2">Spotify Playlist Creator</h2>
        {!token ? (
          <Button onClick={authenticateSpotify}>Login with Spotify</Button>
        ) : (
          <>
            <Input
              placeholder="Paste your songs (one per line)"
              value={songs}
              onChange={(e) => setSongs(e.target.value)}
              className="w-full p-2 border rounded mb-2"
            />
            <Button onClick={createPlaylist}>Create Playlist</Button>
          </>
        )}
      </CardContent>
    </Card>
  );
}
