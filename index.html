<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playlist Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1, h2, h3 {
            color: #1DB954;
        }
        
        .container {
            background-color: #181818;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px 10px 0;
        }
        
        button:hover {
            background-color: #1ed760;
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #333;
            background-color: #333;
            color: white;
        }
        
        .song-entry {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .song-entry input {
            flex-grow: 1;
            margin-right: 10px;
        }
        
        #songList {
            margin-top: 20px;
        }
        
        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #282828;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .song-info {
            flex-grow: 1;
        }
        
        .song-actions button {
            padding: 5px 10px;
            margin-left: 5px;
        }
        
        .page {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .success-message {
            background-color: #1DB954;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .error {
            background-color: #E61E32;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Spotify Playlist Maker</h1>
    
    <!-- Login Page -->
    <div id="loginPage" class="page active">
        <div class="container">
            <h2>Login to Spotify</h2>
            <p>To create playlists, you need to authorize access to your Spotify account.</p>
            <button id="loginButton">Login with Spotify</button>
        </div>
    </div>
    
    <!-- Create Playlist Page -->
    <div id="createPlaylistPage" class="page">
        <div class="container">
            <h2>Create New Playlist</h2>
            <input type="text" id="playlistTitle" placeholder="Enter playlist title">
            
            <div class="song-entry">
                <input type="text" id="songInput" placeholder="Enter artist and song (e.g., Adele - Hello)">
                <button id="addSongButton">Add</button>
            </div>
            
            <div id="songList"></div>
            
            <button id="createPlaylistButton" disabled>Create Playlist</button>
        </div>
    </div>
    
    <!-- Success Page -->
    <div id="successPage" class="page">
        <div class="container">
            <div class="success-message">
                <h2>Playlist Created Successfully!</h2>
                <p>Your playlist has been added to your Spotify account.</p>
            </div>
            <button id="createNewPlaylistButton">Create Another Playlist</button>
        </div>
    </div>
    
    <!-- Loading indicator -->
    <div id="loadingPage" class="page">
        <div class="loading">
            <h3>Processing...</h3>
            <p>Please wait while we process your request.</p>
        </div>
    </div>
    
    <script>
        // Spotify Authentication 
        const clientId = '82910fe423f24953a93aa6188fd25c58';
        const redirectUri = 'https://jrakwasi.github.io/akwasi/';
        
        // Application State
        let accessToken = '';
        let userId = '';
        let songs = [];
        
        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const createPlaylistPage = document.getElementById('createPlaylistPage');
        const successPage = document.getElementById('successPage');
        const loadingPage = document.getElementById('loadingPage');
        const loginButton = document.getElementById('loginButton');
        const playlistTitle = document.getElementById('playlistTitle');
        const songInput = document.getElementById('songInput');
        const addSongButton = document.getElementById('addSongButton');
        const songList = document.getElementById('songList');
        const createPlaylistButton = document.getElementById('createPlaylistButton');
        const createNewPlaylistButton = document.getElementById('createNewPlaylistButton');
        
        // Event Listeners
        loginButton.addEventListener('click', authorizeWithSpotify);
        addSongButton.addEventListener('click', analyzeSongInput);
        createPlaylistButton.addEventListener('click', createPlaylist);
        createNewPlaylistButton.addEventListener('click', resetToCreatePage);
        songInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                analyzeSongInput();
            }
        });
        
        // Check if we're returning from Spotify authorization
        window.onload = function() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const params = new URLSearchParams(hash);
                accessToken = params.get('access_token');
                if (accessToken) {
                    // Clear hash from URL
                    history.replaceState(null, null, ' ');
                    // Get user profile
                    fetchUserProfile();
                }
            }
        };
        
        function showPage(pageElement) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show the requested page
            pageElement.classList.add('active');
        }
        
        function authorizeWithSpotify() {
            const scopes = 'playlist-modify-public playlist-modify-private';
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}&response_type=token`;
            window.location.href = authUrl;
        }
        
        function fetchUserProfile() {
            showPage(loadingPage);
            
            fetch('https://api.spotify.com/v1/me', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user profile');
                }
                return response.json();
            })
            .then(data => {
                userId = data.id;
                showPage(createPlaylistPage);
            })
            .catch(error => {
                console.error('Error fetching user profile:', error);
                showPage(loginPage);
                alert('Authentication failed. Please try again.');
            });
        }
        
        async function analyzeSongInput() {
            const input = songInput.value.trim();
            if (!input) return;
            
            showPage(loadingPage);
            
            try {
                // Simulate AI analysis to extract artist and song
                // In a real app, you might use Claude API here
                const result = analyzeArtistAndSong(input);
                
                // Add to our songs array
                songs.push(result);
                
                // Update UI
                renderSongList();
                songInput.value = '';
                
                // Enable create playlist button if we have at least one song
                createPlaylistButton.disabled = songs.length === 0;
                
                showPage(createPlaylistPage);
            } catch (error) {
                console.error('Error analyzing song input:', error);
                showPage(createPlaylistPage);
                
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = 'Error analyzing song input. Please try again with format "Artist - Song".';
                songList.prepend(errorDiv);
                
                // Remove error message after 3 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 3000);
            }
        }
        
        function analyzeArtistAndSong(input) {
            // Simple function to extract artist and song
            // This simulates what an AI like Claude might do
            
            // Check if input contains a hyphen (common format: "Artist - Song")
            if (input.includes('-')) {
                const [artist, song] = input.split('-').map(part => part.trim());
                return { artist, song };
            } 
            
            // If no hyphen, try to make a best guess
            // This is very simplified - a real AI would be much more sophisticated
            const words = input.split(' ');
            if (words.length <= 2) {
                // If only 1-2 words, assume it's just a song title
                return { artist: 'Unknown', song: input };
            } else {
                // Otherwise guess that first word is artist, rest is song
                const artist = words[0];
                const song = words.slice(1).join(' ');
                return { artist, song };
            }
        }
        
        function renderSongList() {
            songList.innerHTML = '';
            
            if (songs.length === 0) {
                songList.innerHTML = '<p>No songs added yet.</p>';
                return;
            }
            
            songs.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                
                const songInfo = document.createElement('div');
                songInfo.className = 'song-info';
                songInfo.innerHTML = `<strong>${song.artist}</strong> - ${song.song}`;
                
                const songActions = document.createElement('div');
                songActions.className = 'song-actions';
                
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', () => removeSong(index));
                
                songActions.appendChild(removeButton);
                songItem.appendChild(songInfo);
                songItem.appendChild(songActions);
                songList.appendChild(songItem);
            });
        }
        
        function removeSong(index) {
            songs.splice(index, 1);
            renderSongList();
            createPlaylistButton.disabled = songs.length === 0;
        }
        
        async function createPlaylist() {
            const title = playlistTitle.value.trim();
            if (!title || songs.length === 0) {
                alert('Please enter a playlist title and add at least one song.');
                return;
            }
            
            showPage(loadingPage);
            
            try {
                // Create a new playlist
                const playlistResponse = await fetch(`https://api.spotify.com/v1/users/${userId}/playlists`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: title,
                        description: 'Created with Spotify Playlist Maker',
                        public: true
                    })
                });
                
                if (!playlistResponse.ok) {
                    throw new Error('Failed to create playlist');
                }
                
                const playlistData = await playlistResponse.json();
                const playlistId = playlistData.id;
                
                // Search for each song and add to playlist
                await addSongsToPlaylist(playlistId);
                
                // Show success page
                showPage(successPage);
            } catch (error) {
                console.error('Error creating playlist:', error);
                showPage(createPlaylistPage);
                alert('Error creating playlist. Please try again.');
            }
        }
        
        async function addSongsToPlaylist(playlistId) {
            const trackUris = [];
            
            // For each song, search Spotify and get the first result
            for (const song of songs) {
                const query = `track:${encodeURIComponent(song.song)} artist:${encodeURIComponent(song.artist)}`;
                const searchResponse = await fetch(`https://api.spotify.com/v1/search?q=${query}&type=track&limit=1`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!searchResponse.ok) {
                    console.error('Failed to search for track:', song);
                    continue;
                }
                
                const searchData = await searchResponse.json();
                if (searchData.tracks.items.length > 0) {
                    trackUris.push(searchData.tracks.items[0].uri);
                }
            }
            
            // Add tracks to playlist in batches of 100 (Spotify API limit)
            if (trackUris.length > 0) {
                for (let i = 0; i < trackUris.length; i += 100) {
                    const batch = trackUris.slice(i, i + 100);
                    await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            uris: batch
                        })
                    });
                }
            }
        }
        
        function resetToCreatePage() {
            // Clear all data for a new playlist
            songs = [];
            playlistTitle.value = '';
            songInput.value = '';
            renderSongList();
            createPlaylistButton.disabled = true;
            
            // Show create playlist page
            showPage(createPlaylistPage);
        }
    </script>
</body>
</html>
