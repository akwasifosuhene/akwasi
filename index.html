<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playlist Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1, h2, h3 {
            color: #1DB954;
        }
        
        .container {
            background-color: #181818;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px 10px 0;
        }
        
        button:hover {
            background-color: #1ed760;
        }
        
        button:disabled {
            background-color: #565656;
            cursor: not-allowed;
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #333;
            background-color: #333;
            color: white;
        }
        
        textarea {
            height: 120px;
            resize: vertical;
        }
        
        #songList {
            margin-top: 20px;
        }
        
        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #282828;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .song-info {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }
        
        .song-info img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            border-radius: 4px;
        }
        
        .song-actions button {
            padding: 5px 10px;
            margin-left: 5px;
        }
        
        .page {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .success-message {
            background-color: #1DB954;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .error {
            background-color: #E61E32;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .preview-container {
            background-color: #282828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .preview-song-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            background-color: #333;
            margin-bottom: 8px;
        }
        
        .preview-song-item img {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            border-radius: 4px;
        }
        
        .preview-song-info {
            flex-grow: 1;
        }
        
        .preview-song-actions {
            display: flex;
            align-items: center;
        }
        
        .preview-song-actions button {
            margin-left: 8px;
        }
        
        .audio-player {
            height: 30px;
            margin: 0 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #282828;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: #1DB954;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Spotify Playlist Maker</h1>
    
    <!-- Login Page -->
    <div id="loginPage" class="page active">
        <div class="container">
            <h2>Login to Spotify</h2>
            <p>To create playlists, you need to authorize access to your Spotify account.</p>
            <button id="loginButton">Login with Spotify</button>
        </div>
    </div>
    
    <!-- Create Playlist Page -->
    <div id="createPlaylistPage" class="page">
        <div class="container">
            <h2>Create New Playlist</h2>
            <input type="text" id="playlistTitle" placeholder="Enter playlist title">
            
            <div class="tabs">
                <div class="tab active" data-tab="multipleInput">Multiple Songs</div>
                <div class="tab" data-tab="singleInput">Add One Song</div>
            </div>
            
            <!-- Multiple Songs Input -->
            <div id="multipleInput" class="tab-content active">
                <p>Enter multiple songs, one per line (e.g., "Artist - Song Title")</p>
                <textarea id="multipleSongInput" placeholder="Adele - Hello
The Weeknd - Blinding Lights
Dua Lipa - Don't Start Now"></textarea>
                <button id="analyzeMultipleSongsButton">Analyze Songs</button>
            </div>
            
            <!-- Single Song Input -->
            <div id="singleInput" class="tab-content">
                <p>Enter a single song</p>
                <input type="text" id="songInput" placeholder="Enter artist and song (e.g., Adele - Hello)">
                <button id="addSongButton">Add Song</button>
            </div>
            
            <!-- Song Preview Section -->
            <div id="songPreviewContainer" style="display: none;" class="preview-container">
                <div class="preview-header">
                    <h3>Song Previews from Spotify</h3>
                    <button id="addAllToPlaylistButton">Add Selected to Playlist</button>
                </div>
                <div id="songPreviews"></div>
            </div>
            
            <!-- Playlist Preview Section -->
            <div id="playlistPreview">
                <h3>Your Playlist</h3>
                <div id="songList"></div>
            </div>
            
            <button id="createPlaylistButton" disabled>Create Playlist</button>
        </div>
    </div>
    
    <!-- Success Page -->
    <div id="successPage" class="page">
        <div class="container">
            <div class="success-message">
                <h2>Playlist Created Successfully!</h2>
                <p>Your playlist has been added to your Spotify account.</p>
            </div>
            <button id="createNewPlaylistButton">Create Another Playlist</button>
        </div>
    </div>
    
    <!-- Loading indicator -->
    <div id="loadingPage" class="page">
        <div class="loading">
            <h3>Processing...</h3>
            <p>Please wait while we process your request.</p>
        </div>
    </div>
    
    <script>
        // Spotify Authentication 
        const clientId = '82910fe423f24953a93aa6188fd25c58';
        const redirectUri = 'https://jrakwasi.github.io/akwasi/';
        
        // Application State
        let accessToken = '';
        let userId = '';
        let songs = [];
        let searchResults = [];
        
        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const createPlaylistPage = document.getElementById('createPlaylistPage');
        const successPage = document.getElementById('successPage');
        const loadingPage = document.getElementById('loadingPage');
        const loginButton = document.getElementById('loginButton');
        const playlistTitle = document.getElementById('playlistTitle');
        const songInput = document.getElementById('songInput');
        const multipleSongInput = document.getElementById('multipleSongInput');
        const addSongButton = document.getElementById('addSongButton');
        const analyzeMultipleSongsButton = document.getElementById('analyzeMultipleSongsButton');
        const addAllToPlaylistButton = document.getElementById('addAllToPlaylistButton');
        const songList = document.getElementById('songList');
        const songPreviewContainer = document.getElementById('songPreviewContainer');
        const songPreviews = document.getElementById('songPreviews');
        const createPlaylistButton = document.getElementById('createPlaylistButton');
        const createNewPlaylistButton = document.getElementById('createNewPlaylistButton');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Event Listeners
        loginButton.addEventListener('click', authorizeWithSpotify);
        addSongButton.addEventListener('click', () => analyzeSongInput(songInput.value));
        analyzeMultipleSongsButton.addEventListener('click', analyzeMultipleSongs);
        addAllToPlaylistButton.addEventListener('click', addSelectedToPlaylist);
        createPlaylistButton.addEventListener('click', createPlaylist);
        createNewPlaylistButton.addEventListener('click', resetToCreatePage);
        
        songInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                analyzeSongInput(songInput.value);
            }
        });
        
        // Set up tabs
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId) {
                        content.classList.add('active');
                    }
                });
            });
        });
        
        // Check if we're returning from Spotify authorization
        window.onload = function() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const params = new URLSearchParams(hash);
                accessToken = params.get('access_token');
                if (accessToken) {
                    // Clear hash from URL
                    history.replaceState(null, null, ' ');
                    // Get user profile
                    fetchUserProfile();
                }
            }
        };
        
        function showPage(pageElement) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show the requested page
            pageElement.classList.add('active');
        }
        
        function authorizeWithSpotify() {
            const scopes = 'playlist-modify-public playlist-modify-private user-read-private';
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}&response_type=token`;
            window.location.href = authUrl;
        }
        
        function fetchUserProfile() {
            showPage(loadingPage);
            
            fetch('https://api.spotify.com/v1/me', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user profile');
                }
                return response.json();
            })
            .then(data => {
                userId = data.id;
                showPage(createPlaylistPage);
            })
            .catch(error => {
                console.error('Error fetching user profile:', error);
                showPage(loginPage);
                alert('Authentication failed. Please try again.');
            });
        }
        
        function analyzeMultipleSongs() {
            const input = multipleSongInput.value.trim();
            if (!input) return;
            
            showPage(loadingPage);
            
            // Split by lines
            const lines = input.split('\n').filter(line => line.trim() !== '');
            
            // Process each line
            const promises = lines.map(line => {
                return searchSpotify(line);
            });
            
            // Wait for all searches to complete
            Promise.allSettled(promises)
                .then(results => {
                    // Filter successful results and flatten
                    searchResults = results
                        .filter(result => result.status === 'fulfilled' && result.value.length > 0)
                        .map(result => result.value)
                        .flat();
                    
                    // Show previews
                    renderSearchResults();
                    
                    // Return to create page
                    showPage(createPlaylistPage);
                })
                .catch(error => {
                    console.error('Error analyzing songs:', error);
                    showPage(createPlaylistPage);
                });
        }
        
        async function analyzeSongInput(input) {
            input = input.trim();
            if (!input) return;
            
            showPage(loadingPage);
            
            try {
                // Search Spotify
                const results = await searchSpotify(input);
                searchResults = results;
                
                // Show results
                renderSearchResults();
                
                // Clear input
                songInput.value = '';
                
                // Show create playlist page
                showPage(createPlaylistPage);
            } catch (error) {
                console.error('Error analyzing song input:', error);
                showPage(createPlaylistPage);
                
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = 'Error searching for songs. Please try again.';
                songList.prepend(errorDiv);
                
                // Remove error message after 3 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 3000);
            }
        }
        
        async function searchSpotify(query) {
            // Extract artist and song if possible
            let searchQuery = query;
            let extractedInfo = { artist: '', song: '' };
            
            if (query.includes('-')) {
                const [artist, song] = query.split('-').map(part => part.trim());
                extractedInfo = { artist, song };
                searchQuery = `track:${song} artist:${artist}`;
            } else {
                searchQuery = `track:${query}`;
                extractedInfo = { artist: '', song: query };
            }
            
            // Search Spotify
            const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(searchQuery)}&type=track&limit=5`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to search Spotify');
            }
            
            const data = await response.json();
            
            // Process results
            return data.tracks.items.map(track => ({
                id: track.id,
                name: track.name,
                artist: track.artists.map(a => a.name).join(', '),
                album: track.album.name,
                image: track.album.images.length > 0 ? track.album.images[track.album.images.length - 1].url : null,
                preview_url: track.preview_url,
                uri: track.uri,
                originalQuery: query,
                selected: true
            }));
        }
        
        function renderSearchResults() {
            if (searchResults.length === 0) {
                songPreviewContainer.style.display = 'none';
                return;
            }
            
            songPreviewContainer.style.display = 'block';
            songPreviews.innerHTML = '';
            
            searchResults.forEach((track, index) => {
                const trackElement = document.createElement('div');
                trackElement.className = 'preview-song-item';
                
                // Image
                const img = document.createElement('img');
                img.src = track.image || '/api/placeholder/50/50';
                img.alt = `${track.name} album cover`;
                
                // Info
                const infoDiv = document.createElement('div');
                infoDiv.className = 'preview-song-info';
                infoDiv.innerHTML = `
                    <strong>${track.name}</strong><br>
                    <span>${track.artist}</span><br>
                    <small>${track.album}</small>
                `;
                
                // Actions
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'preview-song-actions';
                
                // Audio preview
                if (track.preview_url) {
                    const audio = document.createElement('audio');
                    audio.className = 'audio-player';
                    audio.controls = true;
                    audio.src = track.preview_url;
                    actionsDiv.appendChild(audio);
                }
                
                // Add/Remove toggle button
                const toggleButton = document.createElement('button');
                toggleButton.textContent = track.selected ? 'Remove' : 'Add';
                toggleButton.style.backgroundColor = track.selected ? '#E61E32' : '#1DB954';
                toggleButton.addEventListener('click', () => {
                    track.selected = !track.selected;
                    toggleButton.textContent = track.selected ? 'Remove' : 'Add';
                    toggleButton.style.backgroundColor = track.selected ? '#E61E32' : '#1DB954';
                });
                actionsDiv.appendChild(toggleButton);
                
                // Assemble
                trackElement.appendChild(img);
                trackElement.appendChild(infoDiv);
                trackElement.appendChild(actionsDiv);
                songPreviews.appendChild(trackElement);
            });
        }
        
        function addSelectedToPlaylist() {
            const selectedTracks = searchResults.filter(track => track.selected);
            
            if (selectedTracks.length === 0) {
                alert('Please select at least one song to add to your playlist.');
                return;
            }
            
            // Add to songs array
            songs = [...songs, ...selectedTracks];
            
            // Clear search results
            searchResults = [];
            songPreviewContainer.style.display = 'none';
            
            // Update playlist preview
            renderSongList();
            
            // Enable create playlist button if we have songs
            createPlaylistButton.disabled = songs.length === 0;
            
            // Clear inputs
            songInput.value = '';
            multipleSongInput.value = '';
        }
        
        function renderSongList() {
            songList.innerHTML = '';
            
            if (songs.length === 0) {
                songList.innerHTML = '<p>No songs added yet.</p>';
                return;
            }
            
            songs.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                
                const songInfo = document.createElement('div');
                songInfo.className = 'song-info';
                
                // Add image if available
                if (song.image) {
                    const img = document.createElement('img');
                    img.src = song.image;
                    img.alt = 'Album cover';
                    songInfo.appendChild(img);
                }
                
                const textInfo = document.createElement('div');
                textInfo.innerHTML = `<strong>${song.name}</strong><br>${song.artist}`;
                songInfo.appendChild(textInfo);
                
                const songActions = document.createElement('div');
                songActions.className = 'song-actions';
                
                // Add audio preview if available
                if (song.preview_url) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = song.preview_url;
                    audio.className = 'audio-player';
                    songActions.appendChild(audio);
                }
                
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', () => removeSong(index));
                
                songActions.appendChild(removeButton);
                songItem.appendChild(songInfo);
                songItem.appendChild(songActions);
                songList.appendChild(songItem);
            });
        }
        
        function removeSong(index) {
            songs.splice(index, 1);
            renderSongList();
            createPlaylistButton.disabled = songs.length === 0;
        }
        
        async function createPlaylist() {
            const title = playlistTitle.value.trim();
            if (!title || songs.length === 0) {
                alert('Please enter a playlist title and add at least one song.');
                return;
            }
            
            showPage(loadingPage);
            
            try {
                // Create a new playlist
                const playlistResponse = await fetch(`https://api.spotify.com/v1/users/${userId}/playlists`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: title,
                        description: 'Created with Spotify Playlist Maker',
                        public: true
                    })
                });
                
                if (!playlistResponse.ok) {
                    throw new Error('Failed to create playlist');
                }
                
                const playlistData = await playlistResponse.json();
                const playlistId = playlistData.id;
                
                // Add songs to playlist
                await addTracksToPlaylist(playlistId);
                
                // Show success page
                showPage(successPage);
            } catch (error) {
                console.error('Error creating playlist:', error);
                showPage(createPlaylistPage);
                alert('Error creating playlist. Please try again.');
            }
        }
        
        async function addTracksToPlaylist(playlistId) {
            const trackUris = songs.map(song => song.uri);
            
            // Add tracks to playlist in batches of 100 (Spotify API limit)
            if (trackUris.length > 0) {
                for (let i = 0; i < trackUris.length; i += 100) {
                    const batch = trackUris.slice(i, i + 100);
                    await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            uris: batch
                        })
                    });
                }
            }
        }
        
        function resetToCreatePage() {
            // Clear all data for a new playlist
            songs = [];
            searchResults = [];
            playlistTitle.value = '';
            songInput.value = '';
            multipleSongInput.value = '';
            songPreviewContainer.style.display = 'none';
            renderSongList();
            createPlaylistButton.disabled = true;
            
            // Show create playlist page
            showPage(createPlaylistPage);
        }
    </script>
</body>
</html>
